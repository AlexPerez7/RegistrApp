{% extends "base.html" %}
{% block content %}
<h2>Actividades de {{ mes }}/{{ anio }}</h2>

<div class="mb-3">
  <strong>Total de horas:</strong> {{ "%.2f"|format(total_horas) }} horas
</div>

{% if horas_por_grupo %}
<div class="mb-3">
  <strong>Horas por grupo:</strong>
  <ul class="mb-0">
    {% for grupo, segundos in horas_por_grupo.items() %}
    <li>{{ grupo }}: {{ "%.2f"|format(segundos / 3600) }} horas</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<form method="GET" class="row g-2 mb-3">
  <div class="col-auto">
    <select name="mes" class="form-select">
      {% for m in range(1, 13) %}
      <option value="{{ m }}" {% if m==mes %}selected{% endif %}>{{ m }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <input type="number" name="anio" class="form-control" value="{{ anio }}">
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-primary">Filtrar</button>
    <a href="{{ url_for('activities.exportar_actividades', mes=mes, anio=anio) }}" class="btn btn-success ms-2">Exportar
      a Excel</a>
  </div>
</form>

{% if actividades_por_dia %}
{% for fecha, actividades in actividades_por_dia.items() %}
<h5 class="mt-4">{{ fecha }}</h5>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Grupo</th>
      <th>Descripción</th>
      <th>Horas</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% set total_segundos_dia = 0 %}
    {% for act in actividades %}
    <tr>
      <td>{{ act.grupo.nombre }}</td>
      <td>{{ act.descripcion }}</td>
      <td>{{ act.horas }}</td>
      <td>
        <a href="{{ url_for('activities.editar_actividad', id=act.id) }}" class="btn btn-sm btn-warning">Editar</a>
        <form action="{{ url_for('activities.eliminar_actividad', id=act.id) }}" method="POST" style="display:inline;">
          <button type="submit" class="btn btn-sm btn-danger"
            onclick="return confirm('¿Estás seguro de que quieres eliminar esta actividad?')">
            Eliminar
          </button>
        </form>
      </td>
    </tr>
    {% set h, m, s = act.horas.split(':') %}
    {% set total_segundos_dia = total_segundos_dia + (h | int) * 3600 + (m | int) * 60 + (s | int) %}
    {% endfor %}
    <tr class="table-secondary">
      <td colspan="2"><strong>Total del día</strong></td>
      <td colspan="2">
        <strong>
          {{ "%.2f"|format((totales_por_dia[fecha] or 0) / 3600) }} horas
        </strong>
      </td>

    </tr>
  </tbody>
</table>
{% endfor %}
{% else %}
<p>No hay actividades registradas en este mes.</p>
{% endif %}

{% endblock %}